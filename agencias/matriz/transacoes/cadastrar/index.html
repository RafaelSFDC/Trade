<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="../../../../assets/css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" href="../../../../assets/css/custom.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css" integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e" crossorigin="anonymous">
    <title>RedeTrade</title>
    <meta name="author" content="Lucas Santana" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.14.0/css/all.css"
      integrity="sha384-HzLeBuhoNPvSl5KYnjx0BT+WB0QEEqLprO+NBkkk5gbc67FTaL7XIGa2w1L0Xbgc"
      crossorigin="anonymous"
    />
  </head>
  <body>

    <div class="wrapper">
      <!-- Sidebar  -->
      <side-bar></side-bar>

      <!-- Page Content  -->
      <div id="content">
        <!-- Navbar -->
        <nav-bar></nav-bar>
        <div class="container py-2">
          <div class="container-simple">
            <p class="text-muted font-weight-bold">Nova transação</p>
          </div>

          <div class="container alerta p-4 bg-white rounded shadow">
            <div class="row">
              <div class="col-md-4 pt-1">
                <label>Comprador</label>
                <input type="text" class="form-control" id="comprador" readonly/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Vendedor</label>
                <input type="text" class="form-control" id="vendedor"/>
              </div>
              <div class="w-100"></div>
              <div class="col-md-4 pt-1">
                <label>Valor RT$</label>
                <input type="text" size="12" onKeyUp="mascaraMoeda(this, event)"  value="" class="form-control" id="valorRT"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Valor R$</label>
                <input type="text" size="12" onKeyUp="mascaraMoeda(this, event)"  value="0" class="form-control" id="valorR"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Número de Parcelas</label>
                <select class="form-control" id="numParcelas">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                </select>
              </div>
              <div class="w-100"></div>
              <div class="col-12">
                <label>Descrição</label>
                <textarea class="form-control mb-3" rows="5" id="descricao"></textarea>
              </div>
              <div class="container">
                <h6 class="mt-3">Avaliação de Atendimento</h2>
                <div class="btn-group d-flex" style="gap: 20px;">
                    <button type="button" class="btn  rounded p-0" onclick="atualizarValor(1)" style="min-width: 220px; height: 115px;font-size: 1.5rem;color: #6ec1e4;border: 1px solid #c0c0c0;"><i class="bi bi-emoji-heart-eyes mr-2" style="font-size: 1.5rem;color: #6ec1e4;"></i>Ótimo</button>
                    <button type="button" class="btn  rounded p-0" onclick="atualizarValor(2)" style="min-width: 220px; height: 115px;font-size: 1.5rem;color: #c9c500;border: 1px solid #c0c0c0;"><i class="bi bi-emoji-laughing mr-2" style="font-size: 1.5rem;color: #c9c500;"></i>Bom</button>
                    <button type="button" class="btn  rounded p-0" onclick="atualizarValor(3)" style="min-width: 220px; height: 115px;font-size: 1.5rem;color: #ffa600;border: 1px solid #c0c0c0;"><i class="bi bi-emoji-frown mr-2" style="font-size: 1.5rem;color: #ffa600;"></i>Ruim</button>
                    <button type="button" class="btn  rounded p-0" onclick="atualizarValor(4)" style="min-width: 220px; height: 115px;font-size: 1.5rem;color: #e70505;border: 1px solid #c0c0c0;"><i class="bi bi-emoji-angry mr-2" style="font-size: 1.5rem;color: #e70505;"></i>Péssimo</button>
                </div>
                <input type="hidden" id="valorAvaliacao" value="">
                <br>
            </div>
              <div class="row button-container">
                <div class="col-4 offset-8 text-right pt-4 button-container">
                  <button type="button" class="btn btn-purple btn-sm" style="width: 155px;height: 45px;">
                    Enviar
                  </button>
                  <button type="button" class="btn btn-orange btn-sm space" style="width: 155px;height: 45px;">
                    Voltar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer-bar></footer-bar>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.js"
      integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script src="../../../../assets/js/bootstrap.js"></script>
    <script src="../../../../assets/js/main.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!-- <script src="/__/firebase/7.21.0/firebase-app.js"></script> -->

    <!-- Import Components -->
    <script src="/components/navbar.js"></script>
    <script src="/components/sidebar2.js"></script>
    <script src="/components/footer.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <!-- <script src="/__/firebase/7.21.0/firebase-analytics.js"></script> -->

    <!-- Initialize Firebase -->
    <!-- <script src="/__/firebase/init.js"></script> -->
    <script src="/assets/js/config.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/jquery.inputmask.min.js"></script>    <script>
      function atualizarValor(valor) {
          let valorAvaliacao = '';
          if(valor == 1) {
            valorAvaliacao = 'Otimo';             
          }else if(valor == 2) {
            valorAvaliacao = 'Bom';             
          }else if(valor == 3) {
            valorAvaliacao = 'Ruim';             
          }else {
            valorAvaliacao = 'Pessimo';
          }
          document.getElementById("valorAvaliacao").value = valorAvaliacao;
          //console.log(valorAvaliacao);
      }
  </script>
    <script>
       function fetchData() {
        $(document).ready(function () {
        // Recupera o cookie
        var cookies = document.cookie.split(';');
        var usuarioId = null;
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.indexOf('usuarioId=') === 0) {
            usuarioId = cookie.substring('usuarioId='.length, cookie.length);
            break;
          }
        }
        // Verifica se o idUsuario foi encontrado
        if (usuarioId === '') {
          console.error('O cookie idUsuario não foi encontrado.');
          return;
        }
        // Monta a URL da requisição GET com o parâmetro idAgencia incluindo o usuarioId
        const apiUrl = `${window.apiBaseUrl}/usuarios?idAgencia=${usuarioId}`;

        // Faz a requisição POST para o servidor
        fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            // Processa os dados JSON recebidos
            // Obtém o elemento do campo de entrada
            var vendedorInput = document.getElementById('vendedor');
            
            // Adiciona um ouvinte de evento para o evento "blur"
            vendedorInput.addEventListener('blur', function() {
              // Obtém o valor digitado no campo de entrada
              var filtro = vendedorInput.value;


              // Filtra os dados com base no número da conta ou no nome fantasia
              var resultadosFiltrados = data.filter(function(usuario) {
                return usuario.conta.includes(filtro) || usuario.nomeFantasia.includes(filtro);
              });

              // Exibe os usuários filtrados
              //console.log('Usuários retornados:', resultadosFiltrados);
              // Verifica se existem resultados filtrados
              if (resultadosFiltrados.length > 0) {
                // Obtém o primeiro resultado filtrado
                var primeiroResultado = resultadosFiltrados[0];
                
                // Preenche o campo de entrada com o nome fantasia ou conta encontrado
                vendedorInput.value = primeiroResultado.nomeFantasia || primeiroResultado.conta;
                // Se houver resultados, envie a requisição
                enviarRequisicao();
              } else {
                // Se não houver resultados, exiba uma mensagem de erro ou tome a ação desejada
                showAlert('Nenhum resultado encontrado. Preencha os critérios de filtragem corretamente.', 'danger');
              }
            });   
            data.forEach(usuario => {
              // Cria uma linha na tabela para cada transação
              //console.log('Usuarios retornados',usuario);
              var compradorInput = document.getElementById('comprador');
              if (usuario.id == usuarioId) {
                nomeFantasia = usuario.nomeFantasia;
                compradorInput.value = nomeFantasia;
              }
        
            });
          })
          .catch(error => console.error('Erro:', error));
        });
        
      }
      // Chama a função fetchData para realizar a requisição
      fetchData(); 
      // Encontra o botão de envio
      var enviarBtn = document.querySelector('.btn-purple');
      function enviarRequisicao() {
        // Aqui você pode prosseguir com o código para enviar a requisição
        // Adiciona um evento de clique ao botão
        enviarBtn.addEventListener('click', function() {
          // Obtém os valores dos inputs
          var comprador = document.querySelector('#comprador').value;
          var vendedor = document.querySelector('#vendedor').value;
          var valorRT = document.querySelector('#valorRT').value;
          var valorR = document.querySelector('#valorR').value;
          var numParcelas = document.querySelector('#numParcelas').value;
          var descricao = document.querySelector('#descricao').value;
          var valorAvaliacao = document.getElementById("valorAvaliacao").value;

          // Obter a data e hora atual
          const dataHoraAtual = new Date();

          // Converter a data e hora atual para UTC
          const dataHoraUTC = new Date(dataHoraAtual.getTime() - (dataHoraAtual.getTimezoneOffset() * 60000));

          // Formatar a data e hora no formato do MySQL (YYYY-MM-DD HH:MM:SS)
          const dataHoraFormatada = dataHoraUTC.toISOString().slice(0, 19).replace('T', ' ');       
          //console.log(dataHoraFormatada);

          // Verifique se algum campo está vazio
          if (
            comprador === "" ||
            vendedor === "" ||
            valorRT === "" ||
            valorAvaliacao === ""
          ) {
            //console.log(valorAvaliacao);
            // Exiba um alerta informando que os campos devem ser preenchidos
            showAlert("Todos os campos devem ser preenchidos!", "danger");
          } else {
            // Se todos os campos estiverem preenchidos, prossiga com o envio do formulário
            // Coloque o código para enviar a requisição aqui
            // Cria um objeto com os dados da transação
            
            var dadosTransacao = {
              comprador: comprador,
              vendedor: vendedor,
              valorRt: valorRT,
              valorReal: valorR,
              numeroDeParcelas: numParcelas,
              notaDeAtendimento: valorAvaliacao,
              data: dataHoraFormatada,
              descricao: descricao,
              status: "Aprovada"
            };
          //console.log(dadosTransacao);
          // Envia a solicitação Fetch para a rota
          const apiUrl = `${window.apiBaseUrl}/transacoes`;
          fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(dadosTransacao)
          })
            .then(function(response) {
                if (response.ok) {
                  // Transação efetuada com sucesso
                  showAlert("Transação efetuada com sucesso!", "success");
                  setTimeout(() => {
                    location.reload();
                  }, 4000);
                } else {
                  // Erro ao enviar transação
                  response.json().then(function(data) {
                    showAlert(data.message, "danger");
                  });
                }
            })
            .catch(function(error) {
              console.log('Erro de conexão:', error);
              // Trate o erro de conexão
            });
          }
        });
      } 
      function showAlert(message, type) {
        var alert = document.createElement("div");
        alert.classList.add("alert", "alert-" + type);
        alert.innerHTML = message;

        var container = document.querySelector(".alerta");
        container.insertBefore(alert, container.firstChild);

        setTimeout(function () {
            alert.remove();
        }, 3000);
      }    
    </script>
    <script>
      String.prototype.reverse = function(){
        return this.split('').reverse().join(''); 
      };

      function mascaraMoeda(campo,evento){
        var tecla = (!evento) ? window.event.keyCode : evento.which;
        var valor  =  campo.value.replace(/[^\d]+/gi,'').reverse();
        var resultado  = "";
        var mascara = "##.###.###,##".reverse();
        for (var x=0, y=0; x<mascara.length && y<valor.length;) {
          if (mascara.charAt(x) != '#') {
            resultado += mascara.charAt(x);
            x++;
          } else {
            resultado += valor.charAt(y);
            y++;
            x++;
          }
        }
        campo.value = resultado.reverse();
      }
    </script>
  </body>
</html>
