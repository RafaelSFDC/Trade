<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="../../../assets/css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" href="../../../assets/css/custom.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css" integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>RedeTrade</title>
    <meta name="author" content="Lucas Santana" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.14.0/css/all.css"
      integrity="sha384-HzLeBuhoNPvSl5KYnjx0BT+WB0QEEqLprO+NBkkk5gbc67FTaL7XIGa2w1L0Xbgc"
      crossorigin="anonymous"
    />
    <style>
      .required-field-label {
        position: relative;
      }
  
      .required-field-label::after {
        content: "*";
        color: red;
        position: absolute;
        top: 0;
        right: -10px;
      }
    </style>
  </head>
  <body>

    <div class="wrapper">
      <!-- Sidebar  -->
      <side-bar></side-bar>

      <!-- Page Content  -->
      <div id="content">
        <!-- Navbar -->
        <nav-bar></nav-bar>
        <div class="container py-2">
          <div class="container-simple">
            <p class="text-muted font-weight-bold">Cadastrar agências</p>
          </div>

          <div class="container p-4 bg-white rounded shadow">
            <div class="row">
              <div class="col-md-4 pt-1">
                <label>Razão Social</label>
                <input type="text" class="form-control" id="razao-social" />
              </div>
              <div class="col-md-4 pt-1">
                <label>Nome Fantasia</label>
                <input type="text" class="form-control" id="nome-fantasia" />
              </div>
              <div class="col-md-4 pt-1">
                <label>CNPJ</label>
                <input type="text" class="form-control" id="cnpj"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Insc. Estadual</label>
                <input type="text" class="form-control" id="insc-estadual"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Insc. Municipal</label>
                <input type="text" class="form-control" id="insc-municipal"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Mostrar no site</label>
                <select class="form-control" id="mostrar-no-site">
                  <option value="1">Sim</option>
                  <option value="0">Não</option>
                </select>
              </div>
              <div class="col-md-3 pt-1">
                <label>Tipo</label>
                <select class="form-control" id="tipo">
                  <option>Master</option>
                  <option>Comum</option>
                  <option>Filial</option>
                </select>
              </div>
            </div>

            <div class="col-12 border-top border-bottom my-4 py-2">
              <p class="h4 m-0">Contato</p>
            </div>

            <div class="row">
              <div class="col-md-4 pt-1">
                <label>Nome</label>
                <input type="text" class="form-control" id="contato-nome"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Telefone</label>
                <input type="text" class="form-control" id="contato-telefone"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Celular</label>
                <input type="text" class="form-control" id="contato-celular" />
              </div>
              <div class="w-100"></div>
              <div class="col-md-4 pt-1">
                <label>E-mail</label>
                <input type="text" class="form-control" id="contato-email"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>E-mail secundário</label>
                <input type="text" class="form-control" id="contato-email-secundario"/>
              </div>
            </div>

            <div class="col-12 border-top border-bottom my-4 py-2">
              <p class="h4 m-0">Endereço</p>
            </div>

            <div class="row">
              <div class="col-md-3 pt-1">
                <label>Logradouro</label>
                <input type="text" class="form-control" id="endereco-logradouro"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Numero</label>
                <input type="text" class="form-control" id="endereco-numero"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>CEP</label>
                <input type="text" class="form-control" id="endereco-cep"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Complemento</label>
                <input type="text" class="form-control" id="endereco-complemento"/>
              </div>
              <div class="w-100"></div>
              <div class="col-md-3 pt-1">
                <label>Bairro</label>
                <input type="text" class="form-control" id="endereco-bairro"/>
              </div>
              <div class="col-md-4 pt-1">
                <label>Cidade</label>
                <input type="text" class="form-control" id="endereco-cidade"/>
              </div>
              <div class="col-md-2 pt-1">
                <label>Estado</label>
                <input type="text" class="form-control" id="endereco-estado"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Região</label>
                <input type="text" class="form-control" id="endereco-regiao"/>
              </div>
            </div>

            <div class="col-12 border-top border-bottom my-4 py-2">
              <p class="h4 m-0">Unidade</p>
            </div>

            <div class="row">
              <div class="col-md-3 pt-1">
                <label>Plano de Inscrição</label>
                <select class="form-control" id="plano-inscricao">
                </select>
              </div>

              <div class="col-md-4 pt-1">
                <label>Porcentagem Plano de Inscrição</label>
                <input type="text" class="form-control" id="valor-selecionado" readonly>
              </div>

              <div class="col-md-5 pt-1">
                <label>Nome da Franquia</label>
                <input type="text" class="form-control" id="nomeFranquia"/>
              </div>
            </div>

            <div class="col-12 border-top border-bottom my-4 py-2">
              <p class="h4 m-0">Operações</p>
            </div>

            <div class="row">
              <div class="col-md-3 pt-1">
                <label>Limite Crédito</label>
                <input type="number" step=0.01 class="form-control" id="limite-credito" />
              </div>
              <div class="col-md-3 pt-1">
                <label>Taxa Repasse Matriz em %</label>
                <input type="number" class="form-control" id="taxa-repasse-matriz" />
              </div>
              <div class="col-md-3 pt-1">
                <label>Data Vencimento Fatura</label>
                <select class="form-control" id="data-vencimento-fatura">
                  <option>10</option>
                  <option>20</option>
                  <option>30</option>
                </select>
              </div>
              <div class="col-md-3 pt-1">
                <label>Tipo de operação taxa</label>
                <select class="form-control" id="tipo-operacao-taxa">
                  <option>Royalties</option>
                </select>
              </div>
            </div>

            <div class="col-12 border-top border-bottom my-4 py-2">
              <p class="h4 m-0">Dados do Usuario</p>
            </div>

            <div class="row">
              <div class="col-md-3 pt-1">
                <img
                  src="/assets/img/default_img.png"
                  class="rounded float-left img-fluid"
                  alt="..."
                  id="imagem-selecionada"
                />
              </div>
              <div class="w-100"></div>
              <div class="col-md-3 pt-1">
                <label>Selecionar Foto</label>
                <div class="custom-file mb-3">
                  <input
                    type="file"
                    class="custom-file-input"
                    id="imagem"
                    name="imagem"
                  />
                  <label class="custom-file-label d-hide" for="customFile"
                    >Selecionar</label
                  >
                </div>
              </div>
              <div class="col-md-3 pt-1">
                <label>Nome</label>
                <input type="text" class="form-control" id="usuario-nome"/>
              </div>
              <div class="col-md-3 pt-1">
                <label>Cpf</label>
                <input type="text" class="form-control" id="usuario-cpf"/>
              </div>
              <div class="col-md-3 pt-1">
                <label class="required-field-label">E-mail</label>
                <input type="text" class="form-control" id="usuario-email" required />
              </div>
              <div class="w-100"></div>
              <div class="col-4 offset-8 text-right pt-4">
                <button type="button" class="btn btn-orange w-50 btn-sm" id="botao-salvar">
                  Salvar
                </button>
              </div>
              <div class="container alert"></div>
            </div>
          </div>
        </div>
        <footer-bar></footer-bar>
      </div>
    </div>
    
    <script 
       src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js">
    </script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script src="/assets/js/bootstrap.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/session.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!-- <script src="/__/firebase/7.21.0/firebase-app.js"></script> -->

    <!-- Import Components -->
    <script src="/components/navbar.js"></script>
    <script src="/components/sidebar2.js"></script>
    <script src="/components/footer.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>


    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <!-- <script src="/__/firebase/7.21.0/firebase-analytics.js"></script> -->

    <!-- Initialize Firebase -->
    <!-- <script src="/__/firebase/init.js"></script> -->
    <script src="/assets/js/config.js"></script>

      <script>
			document.addEventListener('DOMContentLoaded', function() {
        const apiUrl = `${window.apiBaseUrl}/planosAgencia`;

        fetch(apiUrl, {
          method: 'GET',
          headers: {
          'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(planos => {
          // Processar os dados recebidos da API
          console.log(planos);
          planos.forEach((plano, index) => {
            // Obtém a referência para o elemento <select>
            const planoInscricao = document.getElementById('plano-inscricao');
            // Cria um elemento de opção
            const option = document.createElement('option');
            // Define o texto da opção como o nome do plano
            option.textContent = plano.nome;
            // Define o valor da opção como o ID do plano
            option.value = plano.porcentagem;
            // Adiciona a opção ao elemento <select>
            planoInscricao.appendChild(option);

            // Verifica se é o primeiro resultado e define como selecionado por padrão
            if (index === 0) {
            option.selected = true;
            const valorSelecionado = document.getElementById('valor-selecionado');
            valorSelecionado.value = option.value + " %";
            }
          });

          const valorSelecionado = document.getElementById('valor-selecionado');
          const planoInscricao = document.getElementById('plano-inscricao');

          planoInscricao.addEventListener('change', () => {
            const selectedValue = planoInscricao.value;
            valorSelecionado.value = selectedValue + " %";
          });
          })
          .catch(error => {
          // Tratar erros da requisição
          console.error('Erro na requisição:', error);
          });


        });
		  </script>
      <!-- Carregar Imagem -->
		  <script>
        // Adiciona um evento de escuta ao input file
        document.getElementById('imagem').addEventListener('change', function(event) {
          // Obtém o elemento da imagem selecionada
          var imgElement = document.getElementById('imagem-selecionada');
          
          // Verifica se o usuário selecionou um arquivo
          if (event.target.files.length > 0) {
          // Obtém o arquivo selecionado pelo usuário
          var file = event.target.files[0];
          
          // Cria um URL temporário para a imagem selecionada
          var imageURL = URL.createObjectURL(file);
          
          // Define o URL temporário como o atributo src da tag img
          imgElement.src = imageURL;
          } else {
          // Caso o usuário não tenha selecionado um arquivo, exibe a imagem padrão
          imgElement.src = "/assets/img/default_img.png";
          }
        });
        </script>
    <!-- ViaCep-->
    <script>
      function obterRegiaoPorCEP(cep) {
        cep = cep.replace(/\D/g, '');
    
        const regioes = {
          'Norte': [69000000, 69999999],
          'Nordeste': [40000000, 49999999],
          'Centro-Oeste': [70000000, 78999999],
          'Sudeste': [1000000, 39999999],
          'Sul': [80000000, 99999999]
        };
    
        for (const regiao in regioes) {
          const intervalo = regioes[regiao];
          const cepNumerico = parseInt(cep);
    
          if (cepNumerico >= intervalo[0] && cepNumerico <= intervalo[1]) {
            return regiao;
          }
        }
    
        return null;
      }
    
      document.getElementById('endereco-cep').addEventListener('input', function() {
        var cep = document.getElementById('endereco-cep').value;
        if (cep.length === 8) {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://viacep.com.br/ws/' + cep + '/json/');
          xhr.onload = function() {
            if (xhr.status === 200) {
              var endereco = JSON.parse(xhr.responseText);
              //console.log(endereco);
              document.getElementById('endereco-logradouro').value = endereco.logradouro;
              document.getElementById('endereco-bairro').value = endereco.bairro;
              document.getElementById('endereco-cidade').value = endereco.localidade;
              document.getElementById('endereco-estado').value = endereco.uf;
    
              var regiao = obterRegiaoPorCEP(cep);
              if (regiao) {
                //console.log(`O CEP ${cep} está na região ${regiao}.`);
                document.getElementById('endereco-regiao').value = regiao;
              } else {
                //console.log(`Não foi possível determinar a região para o CEP ${cep}.`);
              }
            } else {
              alert('Erro ao consultar CEP. Por favor, tente novamente mais tarde.');
            }
          };
          xhr.send();
        }
      });
    
      function formatarCep(event) {
        const cepInput = document.getElementById('endereco-cep');
        const cepValue = cepInput.value.trim();
    
        if (cepValue.length === 5 && event.key !== 'Backspace') {
          cepInput.value = cepValue + '-';
        }
      }
    </script>
    <!-- Script Cadastrar-->
    <script>
      // Perform validation
      function isEmpty(value) {
        return value === undefined || value === null || value === '';
      }

      function areFieldsEmpty(field1, field2) {
        return isEmpty(field1) || isEmpty(field2);
      }
      const apiUrl = `${window.apiBaseUrl}/usuarios`;

      // Função de callback para o evento de clique no botão "Salvar"
      function salvarDados() {
        const razaoSocial = document.getElementById('razao-social').value;
        const nomeFantasia = document.getElementById('nome-fantasia').value;
        const cnpj = document.getElementById('cnpj').value;
        const inscEstadual = document.getElementById('insc-estadual').value;
        const inscMunicipal = document.getElementById('insc-municipal').value;
        const mostrarNoSite = document.getElementById('mostrar-no-site').value;
        const tipo = document.getElementById('tipo').value;
        const contatoNome = document.getElementById('contato-nome').value;
        const contatoTelefone = document.getElementById('contato-telefone').value;
        const contatoCelular = document.getElementById('contato-celular').value;
        const contatoEmail = document.getElementById('contato-email').value;
        const contatoEmailSecundario = document.getElementById('contato-email-secundario').value;
        const enderecoLargadouro = document.getElementById('endereco-logradouro').value;
        const enderecoNumero = document.getElementById('endereco-numero').value;
        const enderecoCEP = document.getElementById('endereco-cep').value;
        const enderecoComplemento = document.getElementById('endereco-complemento').value;
        const enderecoBairro = document.getElementById('endereco-bairro').value;
        const enderecoCidade = document.getElementById('endereco-cidade').value;
        const enderecoEstado = document.getElementById('endereco-estado').value;
        const enderecoRegiao = document.getElementById('endereco-regiao').value;
        //const dataCadastro = document.getElementById('data-cadastro').value;
        const dataAtual = new Date();
        const dia = dataAtual.getDate();
        const mes = dataAtual.getMonth() + 1; // Os meses são indexados a partir de 0
        const ano = dataAtual.getFullYear();
        const dataFormatada = `${ano}/${mes}/${dia}`;
        const dataCadastro = dataFormatada;
        const nomeFranquia = document.getElementById('nomeFranquia').value;
        const planoInscricao = document.getElementById('plano-inscricao');
        const planoSelecionado = planoInscricao.options[planoInscricao.selectedIndex];
        // Obtém o texto do plano selecionado
        const textoPlanoSelecionado = planoSelecionado.text;
        let porcentagemPlanoDeInscricao = document.getElementById('valor-selecionado').value;
        // O método 'replace' é usado com uma expressão regular '/\D/g' para remover todos os caracteres não numéricos (incluindo o sinal de porcentagem) da string, deixando apenas a parte numérica.
        let valorNumerico = parseInt(porcentagemPlanoDeInscricao.replace(/\D/g, ''));

        
        const limiteCredito = document.getElementById('limite-credito').value;
        const taxaRepasseMatriz = document.getElementById('taxa-repasse-matriz').value;
        const dataVencimentoFatura = document.getElementById('data-vencimento-fatura').value;
        const tipoOperacaoTaxa = document.getElementById('tipo-operacao-taxa').value;
        const usuarioNome = document.getElementById('usuario-nome').value;
        const usuarioCPF = document.getElementById('usuario-cpf').value;
        const usuarioEmail = document.getElementById('usuario-email').value;
        const imagem = document.getElementById('imagem');

        // Obtén el valor del cookie
        var cookies = document.cookie.split(';');
        var usuarioId = null;

        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.indexOf('usuarioId=') === 0) {
            usuarioId = cookie.substring('usuarioId='.length, cookie.length);
            break;
          }
        }

        if (areFieldsEmpty(usuarioEmail, nomeFantasia)) {
          showAlert("Por favor, preencha todos os campos obrigatorios. nome Fantasia e Email", "danger");
          return; // Stop form submission
        }

        const formData = new FormData();

        formData.append('dados_usuario[nome]', usuarioNome);
        formData.append('dados_usuario[cpf]', usuarioCPF);
        formData.append('dados_usuario[email]', usuarioEmail);

        formData.append('dados_operacoes[taxaRepasseMatriz]', taxaRepasseMatriz);
        formData.append('dados_operacoes[limiteDeCredito]', limiteCredito);
        formData.append('dados_operacoes[saldoDePermuta]', 0);
        formData.append('dados_operacoes[tipoDeOperacaoTaxa]', tipoOperacaoTaxa);
        formData.append('dados_operacoes[dataVencimentoFatura]', dataVencimentoFatura);

        formData.append('dados_agencia[dataDeAfiliacao]', dataCadastro);
        formData.append('dados_agencia[nomeFranquia]', nomeFranquia);
        formData.append('dados_agencia[planoDeInscricao]', textoPlanoSelecionado);
        formData.append('dados_agencia[porcentagemPlanoDeInscricao]', valorNumerico);
        formData.append('dados_agencia[idUsuario]', usuarioId);

        formData.append('dados_contato[nome_contato]', contatoNome);
        formData.append('dados_contato[telefone]', contatoTelefone);
        formData.append('dados_contato[celular]', contatoCelular);
        formData.append('dados_contato[email_contato]', contatoEmail);
        formData.append('dados_contato[email_secundario]', contatoEmailSecundario);

        formData.append('dados_endereco[logradouro]', enderecoLargadouro);
        formData.append('dados_endereco[numero]', enderecoNumero);
        formData.append('dados_endereco[cep]', enderecoCEP);
        formData.append('dados_endereco[complemento]', enderecoComplemento);
        formData.append('dados_endereco[bairro]', enderecoBairro);
        formData.append('dados_endereco[cidade]', enderecoCidade);
        formData.append('dados_endereco[estado]', enderecoEstado);
        formData.append('dados_endereco[regiao]', enderecoRegiao);

        formData.append('dados_gerais[razaoSocial]', razaoSocial);
        formData.append('dados_gerais[nomeFantasia]', nomeFantasia);
        formData.append('dados_gerais[cnpj]', cnpj);
        formData.append('dados_gerais[inscEstadual]', inscEstadual);
        formData.append('dados_gerais[inscMunicipal]', inscMunicipal);
        formData.append('dados_gerais[mostrarNoSite]', mostrarNoSite);
        formData.append('dados_gerais[tipo]', tipo);

        const img_path = imagem.files[0];

        // Adicionar a imagem do usuário
        formData.append('imagem', img_path);
        //console.log(img_path);
        //return;

        fetch(apiUrl, {
          method: 'POST',
          headers: {
          },
          body: formData,
        })
          .then(response => response.json())
          .then(result => {
            console.log('Resposta do servidor:', result.error);
            if(result.error) {
              const msgError = result.error;
              showAlert(msgError, "danger");
            }else {
              // Realizar ações adicionais após o sucesso da requisição...
              showAlert("Cadastro efetuado com sucesso!", "success");
              // Fechar o modal após 7 segundos
              // Recarregar a página após 7 segundos
              setTimeout(() => {
                location.reload();
              }, 7000);
            }
          })
          .catch(error => {
            console.error('Erro ao enviar requisição:', error);
            // Realizar tratamento de erro, se necessário...
          });
      }

      // Obtém uma referência ao botão "Salvar"
      const botaoSalvar = document.getElementById('botao-salvar');

      // Adiciona um event listener ao botão "Salvar"
      botaoSalvar.addEventListener('click', salvarDados);

      function showAlert(message, type) {
        var alert = document.createElement("div");
        alert.classList.add("alert", "alert-" + type);
        alert.innerHTML = message;

        var container = document.querySelector(".alert");
        container.insertBefore(alert, container.firstChild);

        setTimeout(function () {
            alert.remove();
        }, 3000);
      }

    </script>
    <!-- Script Mascaras-->
    <script>
      $(document).ready(function() {
        $('#usuario-cpf').inputmask('999.999.999-99', { placeholder: '___.___.___-__' });
        $('#cnpj').inputmask('99.999.999/9999-99', { placeholder: '__.___.___/____-__' });
      });
    </script>
  </body>
</html>
