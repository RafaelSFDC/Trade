<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="/assets/css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" href="/assets/css/custom.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"
      integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>RedeTrade</title>
    <meta name="author" content="Lucas Santana" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.14.0/css/all.css"
      integrity="sha384-HzLeBuhoNPvSl5KYnjx0BT+WB0QEEqLprO+NBkkk5gbc67FTaL7XIGa2w1L0Xbgc"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar  -->
      <side-bar></side-bar>

      <!-- Page Content  -->
      <div id="content">
        <!-- Navbar -->
        <nav-bar></nav-bar>
        <div class="container py-2">
          <div class="container-simple">
            <p class="text-muted font-weight-bold">Extrato</p>
          </div>

          <div class="container p-4 bg-white rounded shadow">
            <div class="row">
              <div class="col-md-3 pt-1">
                <label>Agência</label>
                <select class="form-control">
                  <option>Selecionar</option>
                </select>
              </div>
              <div class="col-md-3 pt-1">
                <label>Associado</label>
                <select class="form-control">
                  <option>Selecionar</option>
                </select>
              </div>
              <div class="col-md-3 pt-1">
                <label>Mês</label>
                <select class="form-control">
                  <option>Selecionar</option>
                </select>
              </div>
              <div class="col-md-3 pt-1 lastE">
                <label>Ano</label>
                <select class="form-control">
                  <option>Selecionar</option>
                </select>
              </div>
              <div class="row button-container">
                <div class="col-4 offset-8 text-right pt-4 button-container">
                  <button type="button" class="btn btn-purple btn-sm">
                    Pesquisar
                  </button>
                  <button type="button" class="btn btn-orange btn-sm space">
                    Gerar PDF
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="container-simple">
            <div class="row">
              <div class="col">
                <p
                  class="text-muted font-weight-5"
                  id="dataConsulta"
                  style="font-size: 0.95rem !important"
                >
                  Data da Consulta: 12/07/2023
                </p>
                <p
                  class="text-muted font-weight-5 mt-1"
                  style="font-size: 0.95rem !important"
                >
                  SALDO ATUAL RT$:
                </p>
              </div>
              <div class="col d-flex flex-column align-items-end">
                <p
                  class="lastE"
                  style="font-size: 0.95rem !important"
                  id="periodoDaConsulta"
                >
                  PERÍODO: 00/00/0000 - 00/00/0000
                </p>
                <p
                  class="mt-1"
                  style="font-size: 1.5rem !important"
                  id="saldoAtual"
                ></p>
              </div>
            </div>
          </div>

          <div class="container" style="background-color: #fff">
            <table
              class="table table-borderless table-hover"
              id="unidadesTable"
            >
              <thead>
                <tr id="headerRow">
                  <th scope="col" style="font-size: 0.9rem">CÓDIGO</th>
                  <th scope="col" style="font-size: 0.9rem">DATA</th>
                  <th scope="col" style="font-size: 0.9rem">
                    ASSOCIADO (solicitante)
                  </th>
                  <th scope="col" style="font-size: 0.9rem">ORIGEM</th>
                  <th scope="col" style="font-size: 0.9rem">
                    SALDO ANTERIOR RT$
                  </th>
                  <th scope="col" style="font-size: 0.9rem">OPERAÇÃO RT$</th>
                  <th scope="col" style="font-size: 0.9rem">COMISSÃO R$</th>
                  <th scope="col" style="font-size: 0.9rem">SALDO RT$</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="align-middle" id="codigo"></td>
                  <td class="align-middle" id="data"></td>
                  <td class="align-middle" id="associadoSolicitante"></td>
                  <td class="align-middle" id="origem"></td>
                  <td class="align-middle" id="saldoAnterior"></td>
                  <td class="align-middle" id="operacao"></td>
                  <td class="align-middle" id="comissao"></td>
                  <td class="align-middle" id="saldoAtual"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <footer-bar></footer-bar>
      </div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.js"
      integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script src="/assets/js/bootstrap.js"></script>
    <script src="/assets/js/main.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!-- <script src="/__/firebase/7.21.0/firebase-app.js"></script> -->

    <!-- Import Components -->
    <script src="/components/navbar.js"></script>
    <script src="/components/sidebar2.js"></script>
    <script src="/components/footer.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <!-- <script src="/__/firebase/7.21.0/firebase-analytics.js"></script> -->

    <!-- Initialize Firebase -->
    <!-- <script src="/__/firebase/init.js"></script> -->

    <script>
      // Função para formatar uma data como "dd/mm/yyyy"
      function formatarData(data) {
        const dia = data.getDate().toString().padStart(2, "0");
        const mes = (data.getMonth() + 1).toString().padStart(2, "0");
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }

      // Função para definir a data atual e o intervalo de datas do mês anterior
      function inicializarDatas() {
        const dataAtual = new Date();
        const dataMesAnterior = new Date();
        dataMesAnterior.setMonth(dataMesAnterior.getMonth() - 1);

        const dataConsultaElemento = document.getElementById("dataConsulta");
        const periodoDaConsultaElemento =
          document.getElementById("periodoDaConsulta");

        dataConsultaElemento.textContent = `Data da Consulta: ${formatarData(
          dataAtual
        )}`;
        periodoDaConsultaElemento.textContent = `PERÍODO: ${formatarData(
          dataMesAnterior
        )} - ${formatarData(dataAtual)}`;
        // Recupera o cookie
        var cookies = document.cookie.split(";");
        var usuarioId = null;
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.indexOf("usuarioId=") === 0) {
            usuarioId = cookie.substring("usuarioId=".length, cookie.length);
            break;
          }
        }
        // Verifica se o idUsuario foi encontrado
        if (usuarioId === "") {
          console.error("O cookie idUsuario não foi encontrado.");
          return;
        }
        const apiUrl = `${window.apiBaseUrl}/usuarios/listar/${usuarioId}`;

        fetch(apiUrl)
          .then((response) => response.json())
          .then((data) => {
            //console.log(data);
            data.transacoes.forEach((transacao) => {
              if (
                transacao.idComprador == usuarioId ||
                transacao.idVendedor == usuarioId
              ) {
                console.log("Transações", transacao);

                // Cria uma nova linha (tr)
                const novaLinha = document.createElement("tr");

                // Cria as células (td) e atribui os valores correspondentes
                const codigoCell = document.createElement("td");
                codigoCell.className = "align-middle";
                codigoCell.textContent = transacao.codigo;
                novaLinha.appendChild(codigoCell);

                const dataCell = document.createElement("td");
                dataCell.className = "align-middle";
                const dataFormatada = formatarData(transacao.data);
                console.log(dataFormatada); // Output: 10/07/2023
                dataCell.textContent = dataFormatada;
                novaLinha.appendChild(dataCell);

                const associadoCell = document.createElement("td");
                associadoCell.className = "align-middle";

                // Create the <small> element
                const associadoSmall = document.createElement("small");
                associadoSmall.className = "extrato-associado-col";

                // Create the text node for the seller name
                const associadoText = document.createTextNode(
                  transacao.vendedor
                );

                // Create the <em> element for the seller's name in parentheses
                const associadoEm = document.createElement("em");
                associadoEm.className = "text-muted";

                // Create the text node for the seller's name
                const associadoEmText = document.createTextNode(
                  "(" + transacao.comprador + ")"
                ); // Use transacao.idComprador here

                // Append the text nodes to the corresponding elements
                associadoSmall.appendChild(associadoText);
                associadoEm.appendChild(associadoEmText);
                associadoSmall.appendChild(document.createElement("br"));
                associadoSmall.appendChild(associadoEm);

                // Append the <small> element to the <td> cell
                associadoCell.appendChild(associadoSmall);

                novaLinha.appendChild(associadoCell);

                const origemCell = document.createElement("td");
                origemCell.className = "align-middle";
                let origem;
                if (transacao.idComprador == usuarioId) {
                  origem = "Comprador";
                } else if (transacao.idVendedor == usuarioId) {
                  origem = "Vendedor";
                }
                origemCell.textContent = origem;
                novaLinha.appendChild(origemCell);

                const saldoAnteriorCell = document.createElement("td");
                saldoAnteriorCell.className = "align-middle";
                if (origem == "Vendedor") {
                  let saldoFormatado = Math.abs(
                    transacao.saldoAnteriorVendedor
                  ).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });
                  saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAnteriorCell.textContent = saldoFormatado;
                } else {
                  let saldoFormatado = Math.abs(
                    transacao.saldoAnteriorComprador
                  ).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });
                  saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAnteriorCell.textContent = saldoFormatado;
                }
                novaLinha.appendChild(saldoAnteriorCell);

                const operacaoCell = document.createElement("td");
                operacaoCell.className = "align-middle";
                let valorRtFormatado = Math.abs(
                  transacao.valorRt
                ).toLocaleString("pt-BR", {
                  style: "currency",
                  currency: "BRL",
                });
                valorRtFormatado = valorRtFormatado.substring(3); // Remove o símbolo "R$"
                operacaoCell.textContent = valorRtFormatado;
                novaLinha.appendChild(operacaoCell);

                const comissaoCell = document.createElement("td");
                comissaoCell.className = "align-middle";
                let saldoFormatado = Math.abs(
                  transacao.comissao
                ).toLocaleString("pt-BR", {
                  style: "currency",
                  currency: "BRL",
                });
                saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                comissaoCell.textContent = saldoFormatado;
                novaLinha.appendChild(comissaoCell);

                const saldoAtualCell = document.createElement("td");
                saldoAtualCell.className = "align-middle";
                if (origem == "Vendedor") {
                  let saldoFormatado = Math.abs(
                    transacao.saldoAposVendedor
                  ).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });
                  saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAtualCell.textContent = saldoFormatado;
                } else {
                  let saldoFormatado = Math.abs(
                    transacao.saldoAposComprador
                  ).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });
                  saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAtualCell.textContent = saldoFormatado;
                }
                novaLinha.appendChild(saldoAtualCell);

                // Adiciona a nova linha à tabela (tbody)
                const tabela = document.getElementById("unidadesTable");
                const tbody = tabela.getElementsByTagName("tbody")[0];
                tbody.appendChild(novaLinha);
              }
            });

            data.usuarios.forEach((usuario) => {
              if (usuario.id == usuarioId) {
                console.log("Meus dados são:", usuario);
                let saldoAtual = document.getElementById("saldoAtual");
                let saldoFormatado = Math.abs(
                  usuario.saldoDePermuta
                ).toLocaleString("pt-BR", {
                  style: "currency",
                  currency: "BRL",
                });
                if (usuario.saldoDePermuta < 0) {
                  saldoFormatado = "-" + saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAtual.style.cssText = "color: #FF0000!important"; // Vermelho
                } else {
                  saldoFormatado = saldoFormatado.substring(3); // Remove o símbolo "R$"
                  saldoAtual.style.cssText = "color: #2ea4f3!important"; // Azul
                }
                saldoAtual.textContent = saldoFormatado;
              }
            });
          })
          .catch((error) => console.error("Erro:", error));
      }

      // Função para executar quando a página for carregada
      window.addEventListener("load", function () {
        inicializarDatas();
      });
    </script>
    <!-- Script para Formatar a data quevem do Bd neste formato  2023-07-10T12:49:29.000Z -->
    <script>
      function formatarData(data) {
        // Criar um objeto Date a partir da string recebida
        const dataObj = new Date(data);

        // Extrair o dia, mês e ano da data
        const dia = dataObj.getDate();
        const mes = dataObj.getMonth() + 1; // Os meses em JavaScript são baseados em zero, então adicionamos 1
        const ano = dataObj.getFullYear();

        // Formatar a data no formato dd/mm/yyyy
        const dataFormatada = `${dia < 10 ? "0" : ""}${dia}/${
          mes < 10 ? "0" : ""
        }${mes}/${ano}`;

        // Retornar a data formatada
        return dataFormatada;
      }

      // Exemplo de uso
      //const dataRecebida = '2023-07-10T12:49:29.000Z';
      //const dataFormatada = formatarData(dataRecebida);
      //console.log(dataFormatada); // Output: 10/07/2023
    </script>
  </body>
</html>
